<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <title>Scraper de Editais - TCC</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <!-- Google Fonts - Roboto -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    
    h1 {
      color: #667eea;
      margin-bottom: 10px;
      font-size: 2em;
      text-align: center;
    }
    
    .subtitle {
      text-align: center;
      color: #666;
      margin-bottom: 10px;
      font-size: 0.9em;
    }

    .ultima-atualizacao {
      text-align: center;
      padding: 10px;
      background: #e6f7ed;
      border-left: 4px solid #48bb78;
      border-radius: 6px;
      margin-bottom: 20px;
      color: #2d3748;
      font-size: 0.9em;
    }

    .ultima-atualizacao.nunca {
      background: #fff5e6;
      border-left-color: #ed8936;
    }

    .ultima-atualizacao strong {
      color: #48bb78;
    }

    .ultima-atualizacao.nunca strong {
      color: #ed8936;
    }
    
    form {
      display: flex;
      gap: 10px;
      margin-bottom: 30px;
      flex-wrap: wrap;
      align-items: center;
      justify-content: center;
    }
    
    input[type="text"] {
      flex: 1;
      min-width: 250px;
      padding: 12px 16px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 1em;
      transition: all 0.3s;
    }
    
    input[type="text"]:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    button, a.btn {
      padding: 12px 24px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      text-decoration: none;
      font-size: 1em;
      font-weight: 500;
      transition: all 0.3s;
      display: inline-block;
    }
    
    button:hover, a.btn:hover {
      background: #5568d3;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }
    
    .btn-secondary {
      background: #48bb78;
    }
    
    .btn-secondary:hover {
      background: #38a169;
    }
    
    .btn-warning {
      background: #ed8936;
    }
    
    .btn-warning:hover {
      background: #dd6b20;
    }
    
    .btn-danger {
      background: #e53e3e;
    }
    
    .btn-danger:hover {
      background: #c53030;
    }
    
    .stats {
      text-align: center;
      margin: 20px 0;
      padding: 15px;
      background: #f7fafc;
      border-radius: 8px;
      color: #4a5568;
    }
    
    .ed {
      margin: 15px 0;
      padding: 20px;
      border: 1px solid #e2e8f0;
      border-radius: 10px;
      background: #f8f9fa;
      transition: all 0.3s;
    }
    
    .ed:hover {
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      transform: translateY(-2px);
    }
    
    .ed-title {
      font-size: 1.1em;
      font-weight: bold;
      color: #2d3748;
      margin-bottom: 10px;
      line-height: 1.4;
    }
    
    .meta {
      color: #718096;
      font-size: 0.9em;
      margin-bottom: 12px;
      line-height: 1.6;
    }
    
    .meta span {
      display: inline-block;
      margin-right: 15px;
    }
    
    .meta span strong {
      color: #4a5568;
    }
    
    .ed-link {
      display: inline-block;
      padding: 8px 16px;
      background: #667eea;
      color: white;
      text-decoration: none;
      border-radius: 6px;
      font-size: 0.9em;
      transition: all 0.3s;
    }
    
    .ed-link:hover {
      background: #5568d3;
      transform: translateX(5px);
    }
    
    .empty {
      text-align: center;
      padding: 60px 20px;
      color: #a0aec0;
    }
    
    .empty svg {
      width: 80px;
      height: 80px;
      margin-bottom: 20px;
      opacity: 0.5;
    }

    /* MODAL DE PROGRESSO */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 12px;
      padding: 30px;
      max-width: 700px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    }

    .modal-header {
      text-align: center;
      margin-bottom: 20px;
    }

    .modal-header h2 {
      color: #667eea;
      margin-bottom: 10px;
    }

    .progress-info {
      text-align: center;
      font-size: 1.1em;
      color: #4a5568;
      margin-bottom: 20px;
    }

    .progress-bar-container {
      background: #e2e8f0;
      height: 8px;
      border-radius: 4px;
      margin-bottom: 30px;
      overflow: hidden;
    }

    .progress-bar {
      background: linear-gradient(90deg, #667eea, #764ba2);
      height: 100%;
      width: 0%;
      transition: width 0.3s ease;
    }

    .agencies-list {
      display: grid;
      gap: 10px;
    }

    .agency-item {
      display: flex;
      align-items: center;
      padding: 12px;
      background: #f7fafc;
      border-radius: 8px;
      transition: all 0.3s;
    }

    .agency-item.processing {
      background: #fff5e6;
      border-left: 4px solid #ed8936;
    }

    .agency-item.completed {
      background: #e6f7ed;
      border-left: 4px solid #48bb78;
    }

    .agency-icon {
      font-size: 1.5em;
      margin-right: 12px;
      min-width: 30px;
      text-align: center;
    }

    .agency-name {
      flex: 1;
      font-weight: 500;
      color: #2d3748;
    }

    .agency-status {
      font-size: 0.85em;
      color: #718096;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .spinning {
      animation: spin 1s linear infinite;
    }

    .modal-footer {
      margin-top: 20px;
      text-align: center;
    }

    .close-btn {
      padding: 10px 20px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1em;
      transition: all 0.3s;
    }

    .close-btn:hover {
      background: #5568d3;
    }

    .close-btn:disabled {
      background: #cbd5e0;
      cursor: not-allowed;
    }
    
    @media (max-width: 768px) {
      .container {
        padding: 20px;
      }
      
      h1 {
        font-size: 1.5em;
      }
      
      form {
        flex-direction: column;
      }
      
      input[type="text"] {
        width: 100%;
      }
      
      button, a.btn {
        width: 100%;
      }
      
      .meta span {
        display: block;
        margin-bottom: 5px;
      }

      .modal-content {
        width: 95%;
        padding: 20px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üéì Scraper de Editais</h1>
    <p class="subtitle">Sistema de Monitoramento de Oportunidades de Financiamento</p>
    
    {% if ultima_coleta %}
      <div class="ultima-atualizacao">
        üïí <strong>√öltima atualiza√ß√£o:</strong> {{ ultima_coleta }}
      </div>
    {% else %}
      <div class="ultima-atualizacao nunca">
        ‚ö†Ô∏è <strong>Nenhuma coleta realizada ainda.</strong> Execute a coleta para come√ßar!
      </div>
    {% endif %}
    
    <form method="get" action="/">
      <input 
        type="text" 
        name="q" 
        placeholder="üîç Buscar por t√≠tulo ou ag√™ncia..." 
        value="{{ termo }}"
      >
      <button type="submit">Buscar</button>
      <a href="/export.csv" class="btn btn-secondary">üì• Exportar CSV</a>
      <a href="#" class="btn btn-warning" onclick="iniciarColeta(event)">üöÄ Executar Coleta</a>
      <a href="/limpar_vencidos" class="btn btn-danger" onclick="return confirm('Deseja remover todos os editais com prazo vencido?')">üóëÔ∏è Limpar Vencidos</a>
    </form>

    {% if editais %}
      <div class="stats">
        üìä <strong>{{ editais|length }}</strong> edita{{ 'is' if editais|length != 1 else 'l' }} encontrado{{ 's' if editais|length != 1 else '' }}
      </div>

      {% for titulo, agencia, prazo, valor, link, fonte, data_publicacao in editais %}
        <div class="ed">
          <div class="ed-title">
            {{ titulo or "(sem t√≠tulo)" }}
          </div>
          
          <div class="meta">
            <span><strong>üè¢ Ag√™ncia:</strong> {{ agencia or "-" }}</span>
            {% if data_publicacao %}
            <span><strong>üìÖ Publicado:</strong> {{ data_publicacao }}</span>
            {% endif %}
            <span><strong>‚è∞ Prazo:</strong> {{ prazo or "N√£o informado" }}</span>
            <span><strong>üí∞ Valor:</strong> {{ valor or "N√£o informado" }}</span>
            <span><strong>üìù Fonte:</strong> {{ fonte or "-" }}</span>
          </div>
          
          {% if link %}
          <a href="{{ link }}" class="ed-link" onclick="window.open(this.href); return false;">
            üìÑ Abrir Edital ‚Üí
          </a>
          {% else %}
          <span style="color: #a0aec0; font-size: 0.9em;">üìÑ Link n√£o dispon√≠vel</span>
          {% endif %}
        </div>
      {% endfor %}
    {% else %}
      <div class="empty">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
        </svg>
        <h2>Nenhum edital cadastrado</h2>
        <p>Execute a coleta para come√ßar a monitorar editais</p>
      </div>
    {% endif %}
    
    <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #e2e8f0; text-align: center; color: #718096; font-size: 0.85em;">
      <p>üìã Monitorando <strong>37 ag√™ncias</strong> de fomento (29 nacionais + 8 internacionais)</p>
      <p style="margin-top: 8px;">ü§ñ Coleta automatizada di√°ria √†s 6h da manh√£</p>
      <p style="margin-top: 8px;">Desenvolvido como TCC por <strong>Rony Gleyson Magalh√£es Barbosa</strong></p>
      <p style="margin-top: 4px; font-size: 0.9em;">Instituto Federal Baiano ‚Ä¢ Campus Guanambi ‚Ä¢ 2025</p>
    </div>
  </div>

  <!-- MODAL DE PROGRESSO -->
  <div class="modal-overlay" id="progressModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>üöÄ Coletando Editais</h2>
        <p style="color: #718096;">Aguarde enquanto processamos as 37 ag√™ncias...</p>
      </div>

      <div class="progress-info">
        <span id="progressText">Iniciando coleta...</span>
      </div>

      <div class="progress-bar-container">
        <div class="progress-bar" id="progressBar"></div>
      </div>

      <div class="agencies-list" id="agenciesList">
        <!-- Ser√° preenchido via JavaScript -->
      </div>

      <div class="modal-footer">
        <button class="close-btn" id="closeBtn" disabled onclick="fecharModal()">
          Aguarde...
        </button>
      </div>
    </div>
  </div>

  <script>
    const AGENCIES = [
      "CNPq", "CAPES", "FINEP", "CONFAP",
      "FAPESP (SP)", "FAPERJ (RJ)", "FAPEMIG (MG)", "FAPES (ES)",
      "FACEPE (PE)", "FAPESQ (PB)", "FAPEAL (AL)", "FUNCAP (CE)", "FAPESB (BA)",
      "FAPERN (RN)", "FAPEPI (PI)", "FAPITEC (SE)", "FAPEMA (MA)",
      "FAPERGS (RS)", "FAPESC (SC)", "Funda√ß√£o Arauc√°ria (PR)",
      "FAPDF (DF)", "FUNDECT (MS)", "FAPEG (GO)",
      "FAPEAM (AM)", "FAPESPA (PA)", "FAPEAC (AC)", "FAPERO (RO)", "FAPTO (TO)", "FAPEAP (AP)",
      "USAID (EUA)", "NSF (EUA)", "Uni√£o Europeia (Horizon)", "AFD (Fran√ßa)", 
      "AECID (Espanha)", "UKRI (Reino Unido)", "NSERC (Canad√°)", "ACA (Academic Cooperation)"
    ];

    function iniciarColeta(event) {
      event.preventDefault();
      
      const modal = document.getElementById('progressModal');
      modal.classList.add('active');
      
      const list = document.getElementById('agenciesList');
      list.innerHTML = '';
      
      AGENCIES.forEach((name, index) => {
        const item = document.createElement('div');
        item.className = 'agency-item';
        item.id = `agency-${index}`;
        item.innerHTML = `
          <div class="agency-icon">‚è∏Ô∏è</div>
          <div class="agency-name">${name}</div>
          <div class="agency-status">Aguardando...</div>
        `;
        list.appendChild(item);
      });
      
      const eventSource = new EventSource('/coletar_stream');
      
      eventSource.onmessage = function(event) {
        const data = JSON.parse(event.data);
        
        if (data.type === 'progress') {
          const percent = (data.current / data.total) * 100;
          document.getElementById('progressBar').style.width = percent + '%';
          document.getElementById('progressText').textContent = 
            `Processando: ${data.current} de ${data.total}`;
          
          const currentItem = document.getElementById(`agency-${data.current - 1}`);
          if (currentItem) {
            currentItem.className = 'agency-item processing';
            currentItem.querySelector('.agency-icon').innerHTML = '<span class="spinning">‚è≥</span>';
            currentItem.querySelector('.agency-status').textContent = 'Processando...';
          }
          
          if (data.current > 1) {
            const prevItem = document.getElementById(`agency-${data.current - 2}`);
            if (prevItem) {
              prevItem.className = 'agency-item completed';
              prevItem.querySelector('.agency-icon').textContent = '‚úÖ';
              prevItem.querySelector('.agency-status').textContent = 'Conclu√≠do';
            }
          }
        }
        
        if (data.type === 'complete') {
          const lastItem = document.getElementById(`agency-${data.total - 1}`);
          if (lastItem) {
            lastItem.className = 'agency-item completed';
            lastItem.querySelector('.agency-icon').textContent = '‚úÖ';
            lastItem.querySelector('.agency-status').textContent = 'Conclu√≠do';
          }
          
          document.getElementById('progressBar').style.width = '100%';
          document.getElementById('progressText').innerHTML = 
            `<strong>‚úÖ Coleta finalizada!</strong> ${data.novos} novos editais encontrados`;
          
          const closeBtn = document.getElementById('closeBtn');
          closeBtn.disabled = false;
          closeBtn.textContent = 'Fechar e Recarregar';
          closeBtn.onclick = function() {
            window.location.reload();
          };
          
          eventSource.close();
        }
      };
      
      eventSource.onerror = function() {
        document.getElementById('progressText').innerHTML = 
          '<strong style="color: #e53e3e;">‚ùå Erro na coleta</strong>';
        document.getElementById('closeBtn').disabled = false;
        document.getElementById('closeBtn').textContent = 'Fechar';
        eventSource.close();
      };
    }

    function fecharModal() {
      document.getElementById('progressModal').classList.remove('active');
    }
  </script>
</body>
</html>
